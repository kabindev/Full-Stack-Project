<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productivity Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
  /* === Integrated style.css === */
  :root {
      --primary-purple: #7c3aed;
      --primary-green: #10b981;
      --bg-light: #f8f9fa;
      --text-dark: #1f2937;
  }
  body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .navbar-brand { font-weight: 700; font-size: 1.5rem; }
  .brand-productivity { color: var(--primary-purple); }
  .brand-hub { color: var(--primary-green); }
  .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
  }
  .username-badge {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      color: var(--primary-purple);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
  }
  .btn-logout {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
  }
  .btn-logout:hover {
      background: #dc2626;
      transform: translateY(-2px);
  }
  .dashboard-title {
      color: var(--primary-purple);
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 0.5rem;
  }
  .subtitle { color: #6b7280; margin-bottom: 2rem; }
  .stat-card {
      border-radius: 1rem; padding: 1.5rem; border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .stat-card-purple { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); }
  .stat-card-green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
  .stat-card-orange { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
  .stat-card-blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
  .stat-icon { font-size: 1.5rem; float: right; }
  .stat-label { color: #6b7280; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
  .stat-value { color: var(--text-dark); font-size: 2rem; font-weight: 700; }
  .section-card {
      background: white; border-radius: 1rem; padding: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;
  }
  .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; }
  .section-icon { font-size: 1.5rem; margin-right: 0.75rem; }
  .input-group-custom { position: relative; }
  .input-custom {
      border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 0.75rem 1rem;
      font-size: 0.95rem; width: 100%;
  }
  .input-custom:focus { outline: none; border-color: var(--primary-purple); }
  .btn-add {
      background: var(--primary-purple); color: white; border: none; border-radius: 0.75rem;
      width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center;
      position: absolute; right: 0; top: 0; cursor: pointer; transition: background 0.2s;
  }
  .btn-add:hover { background: #6d28d9; }
  .task-item, .habit-item {
      padding: 1rem; border-radius: 0.75rem; margin-bottom: 0.75rem;
      background: #f9fafb; display: flex; align-items: center; transition: all 0.3s;
  }
  .task-item:hover, .habit-item:hover { background: #f3f4f6; }
  .task-checkbox { width: 1.25rem; height: 1.25rem; margin-right: 1rem; cursor: pointer; accent-color: var(--primary-purple); }
  .task-title { flex: 1; font-size: 1rem; color: var(--text-dark); }
  .task-completed { text-decoration: line-through; color: #9ca3af; opacity: 0.7; }
  .task-date { font-size: 0.875rem; color: var(--primary-green); margin-left: 1rem; }
  .habit-name { flex: 1; font-size: 1rem; font-weight: 600; color: var(--text-dark); }
  .habit-streak { display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem; }
  .streak-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white; padding: 0.25rem 0.75rem; border-radius: 1rem;
      font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;
  }
  .progress-bar-custom { height: 0.5rem; background: #e5e7eb; border-radius: 1rem; overflow: hidden; width: 100px; }
  .progress-fill { height: 100%; background: var(--primary-purple); border-radius: 1rem; transition: width 0.3s; }
  .done-badge {
      background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem;
      border: none; font-size: 0.875rem; cursor: pointer; transition: background 0.2s;
  }
  .done-badge:hover { background: #059669; }
  .done-badge.completed { background: #d1fae5; color: #059669; cursor: default; }
  .delete-btn {
      background: transparent; border: none; color: #ef4444; cursor: pointer;
      padding: 0.5rem; margin-left: 0.5rem; opacity: 0; transition: opacity 0.2s;
  }
  .task-item:hover .delete-btn, .habit-item:hover .delete-btn { opacity: 1; }
  .delete-btn:hover { color: #dc2626; }
  @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
  }
  .animate-in { animation: fadeInUp 0.3s ease-out; }
  .celebration-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .celebration-content {
      background: white; padding: 3rem; border-radius: 1.5rem;
      text-align: center; max-width: 400px; animation: fadeInUp 0.5s;
  }
  .celebration-emoji { font-size: 4rem; margin-bottom: 1rem; }
  .celebration-text { font-size: 1.5rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1rem; }
  .celebration-subtext { color: #6b7280; margin-bottom: 2rem; }
  .btn-close-modal { background: var(--primary-purple); color: white; border: none; padding: 0.75rem 2rem; border-radius: 0.75rem; cursor: pointer; font-weight: 600; }
  </style>
</head>

<body>
  <!-- Celebration Modal -->
  <div id="celebrationModal" class="celebration-modal">
      <div class="celebration-content">
          <div class="celebration-emoji">üéâ</div>
          <div class="celebration-text" id="celebrationText">Great job!</div>
          <div class="celebration-subtext" id="celebrationSubtext">Keep up the amazing work!</div>
          <button class="btn-close-modal" onclick="closeCelebration()">Continue</button>
      </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
      <div class="container-fluid px-4">
          <span class="navbar-brand mb-0">
              <span class="brand-productivity">Productivity</span> 
              <span class="brand-hub">Hub</span>
          </span>
          <div class="user-info">
              <div class="username-badge">
                  <i class="fas fa-user"></i>
                  <span id="usernameDisplay">User</span>
              </div>
              <button class="btn-logout" onclick="handleLogout()">
                  <i class="fas fa-sign-out-alt"></i> Logout
              </button>
          </div>
      </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid px-4">
      <div class="mb-4">
          <h1 class="dashboard-title">Your Dashboard</h1>
          <p class="subtitle">Track your progress and celebrate wins!</p>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
          <div class="col-md-3 mb-3"><div class="stat-card stat-card-purple"><div class="stat-icon">üèÜ</div><div class="stat-label">Productivity Score</div><div class="stat-value" id="productivityScore">0</div></div></div>
          <div class="col-md-3 mb-3"><div class="stat-card stat-card-green"><div class="stat-icon">üéØ</div><div class="stat-label">Tasks Completed</div><div class="stat-value" id="tasksCompleted">0/0</div></div></div>
          <div class="col-md-3 mb-3"><div class="stat-card stat-card-orange"><div class="stat-icon">üî•</div><div class="stat-label">Total Streak Days</div><div class="stat-value" id="totalStreak">0</div></div></div>
          <div class="col-md-3 mb-3"><div class="stat-card stat-card-blue"><div class="stat-icon">üìà</div><div class="stat-label">Active Habits</div><div class="stat-value" id="activeHabits">0</div></div></div>
      </div>

      <!-- Tasks & Habits -->
      <div class="row">
          <div class="col-md-6 mb-4">
              <div class="section-card">
                  <h2 class="section-title"><span class="section-icon">üìã</span> Tasks</h2>
                  <div class="input-group-custom mb-4">
                      <input type="text" class="input-custom" id="taskInput" placeholder="Add a new task...">
                      <button class="btn-add" onclick="addTask()"><i class="fas fa-plus"></i></button>
                  </div>
                  <div id="tasksList"></div>
              </div>
          </div>

          <div class="col-md-6 mb-4">
              <div class="section-card">
                  <h2 class="section-title"><span class="section-icon">üî•</span> Habits</h2>
                  <div class="input-group-custom mb-4">
                      <input type="text" class="input-custom" id="habitInput" placeholder="Add a new habit...">
                      <button class="btn-add" onclick="addHabit()"><i class="fas fa-plus"></i></button>
                  </div>
                  <div id="habitsList"></div>
              </div>
          </div>
      </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* === Integrated main.js === */
  const API_BASE = '';
  
  function loadCurrentUser() {
      $.get(API_BASE + '/api/current-user', function(data) {
          $('#usernameDisplay').text(data.username);
      }).fail(function() {
          window.location.href = '/login';
      });
  }
  
  function handleLogout() {
      if (!confirm('Are you sure you want to logout?')) return;
      
      $.ajax({
          url: API_BASE + '/api/logout',
          method: 'POST',
          success: function() {
              window.location.href = '/login';
          },
          error: function() {
              alert('Error logging out. Please try again.');
          }
      });
  }
  
  function loadDashboard() {
      $.get(API_BASE + '/api/dashboard', function(data) {
          $('#productivityScore').text(data.productivity_score);
          $('#tasksCompleted').text(data.tasks_completed + '/' + data.total_tasks);
          $('#totalStreak').text(data.total_streak_days);
          $('#activeHabits').text(data.active_habits);
      }).fail(function(xhr) {
          if (xhr.status === 401) {
              window.location.href = '/login';
          }
      });
  }
  
  function loadTasks() {
      $.get(API_BASE + '/api/tasks', function(tasks) {
          const tasksList = $('#tasksList');
          tasksList.empty();
          if (tasks.length === 0) {
              tasksList.html('<p class="text-muted text-center">No tasks yet. Add one above!</p>');
              return;
          }
          tasks.forEach(function(task) {
              const taskItem = $(`
                  <div class="task-item animate-in" data-task-id="${task.id}">
                      <input type="checkbox" class="task-checkbox" ${task.status === 'completed' ? 'checked' : ''} onchange="toggleTask(${task.id})">
                      <span class="task-title ${task.status === 'completed' ? 'task-completed' : ''}">${escapeHtml(task.title)}</span>
                      ${task.due_date ? '<span class="task-date">‚úì ' + formatDate(task.due_date) + '</span>' : ''}
                      <button class="delete-btn" onclick="deleteTask(${task.id})"><i class="fas fa-trash"></i></button>
                  </div>`);
              tasksList.append(taskItem);
          });
      }).fail(function(xhr) {
          if (xhr.status === 401) {
              window.location.href = '/login';
          }
      });
  }
  
  function loadHabits() {
      $.get(API_BASE + '/api/habits', function(habits) {
          const habitsList = $('#habitsList');
          habitsList.empty();
          if (habits.length === 0) {
              habitsList.html('<p class="text-muted text-center">No habits yet. Start building one!</p>');
              return;
          }
          habits.forEach(function(habit) {
              const progress = Math.min((habit.streak / 30) * 100, 100);
              const habitItem = $(`
                  <div class="habit-item animate-in" data-habit-id="${habit.id}">
                      <span class="habit-name">${escapeHtml(habit.name)}</span>
                      <div class="habit-streak">
                          <span class="streak-badge"><i class="fas fa-fire"></i> ${habit.streak}</span>
                          <div class="progress-bar-custom"><div class="progress-fill" style="width: ${progress}%"></div></div>
                      </div>
                      <button class="done-badge ${habit.done_today ? 'completed' : ''}" onclick="markHabitDone(${habit.id})" ${habit.done_today ? 'disabled' : ''}>
                          ${habit.done_today ? '‚úì Done Today!' : 'Mark Done'}
                      </button>
                      <button class="delete-btn" onclick="deleteHabit(${habit.id})"><i class="fas fa-trash"></i></button>
                  </div>`);
              habitsList.append(habitItem);
          });
      }).fail(function(xhr) {
          if (xhr.status === 401) {
              window.location.href = '/login';
          }
      });
  }
  
  function addTask() {
      const title = $('#taskInput').val().trim();
      if (!title) return alert('Please enter a task title!');
      if (title.length > 200) return alert('Task title is too long!');
      $.ajax({
          url: API_BASE + '/api/tasks', method: 'POST', contentType: 'application/json',
          data: JSON.stringify({ title }),
          success: function() { $('#taskInput').val(''); loadTasks(); loadDashboard(); },
          error: function(xhr) {
              if (xhr.status === 401) {
                  window.location.href = '/login';
              } else {
                  alert('Error adding task.');
              }
          }
      });
  }
  
  function toggleTask(id) {
      const checkbox = $(`[data-task-id="${id}"] .task-checkbox`);
      const status = checkbox.is(':checked') ? 'completed' : 'pending';
      $.ajax({
          url: API_BASE + '/api/tasks/' + id, method: 'PUT', contentType: 'application/json',
          data: JSON.stringify({ status }),
          success: function() {
              loadTasks(); loadDashboard();
              if (status === 'completed') showCelebration('Task Completed! üéâ', "You're on fire! Keep it up!");
          },
          error: function(xhr) {
              if (xhr.status === 401) window.location.href = '/login';
          }
      });
  }
  
  function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      $.ajax({ 
          url: API_BASE + '/api/tasks/' + id, 
          method: 'DELETE', 
          success: function() { loadTasks(); loadDashboard(); },
          error: function(xhr) {
              if (xhr.status === 401) window.location.href = '/login';
          }
      });
  }
  
  function addHabit() {
      const name = $('#habitInput').val().trim();
      if (!name) return alert('Please enter a habit name!');
      $.ajax({
          url: API_BASE + '/api/habits', method: 'POST', contentType: 'application/json',
          data: JSON.stringify({ name }),
          success: function() { $('#habitInput').val(''); loadHabits(); loadDashboard(); },
          error: function(xhr) {
              if (xhr.status === 401) window.location.href = '/login';
          }
      });
  }
  
  function markHabitDone(id) {
      $.ajax({
          url: API_BASE + '/api/habits/' + id, method: 'PUT', contentType: 'application/json',
          data: JSON.stringify({ mark_done: true }),
          success: function(habit) {
              loadHabits(); loadDashboard();
              showCelebration(`${habit.streak} Day Streak! üî•`, 'Amazing consistency! Keep building that habit!');
          },
          error: function(xhr) {
              if (xhr.status === 401) window.location.href = '/login';
          }
      });
  }
  
  function deleteHabit(id) {
      if (!confirm('Delete this habit?')) return;
      $.ajax({ 
          url: API_BASE + '/api/habits/' + id, 
          method: 'DELETE', 
          success: function() { loadHabits(); loadDashboard(); },
          error: function(xhr) {
              if (xhr.status === 401) window.location.href = '/login';
          }
      });
  }
  
  function showCelebration(text, subtext) {
      $('#celebrationText').text(text); $('#celebrationSubtext').text(subtext); $('#celebrationModal').css('display', 'flex');
  }
  
  function closeCelebration() { $('#celebrationModal').css('display', 'none'); }
  
  function formatDate(dateStr) {
      const date = new Date(dateStr);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return months[date.getMonth()] + ' ' + date.getDate();
  }
  
  function escapeHtml(text) {
      const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
  }
  
  $(document).ready(function() {
      $('#taskInput').keypress(e => { if (e.which === 13) addTask(); });
      $('#habitInput').keypress(e => { if (e.which === 13) addHabit(); });
      loadCurrentUser();
      loadDashboard(); 
      loadTasks(); 
      loadHabits();
      setInterval(loadDashboard, 30000);
  });
  </script>
</body>
</html>